<!DOCTYPE html>
<html lang="en">
<head>
<meta charset=utf-8>

<title>Cross datacenter UDP reliability - Erik's Code</title>

<meta name=keywords content="UDP datacenter linux go golang">


<link href="/css/common.css" media="screen" rel="stylesheet" type="text/css">
<link href="/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
</head>  
<body>
  <div id="main">
    <div id="header-wrapper">
      <div id="header" class="basic" >
        <div class="site">
          <a class="logo" href="/"><h2>Erik's Code</h2></a>
          <div class="topsearch">
            <ul class="nav logged_out">
              <li><a href="/about.html">About Erik</a></li>
            </ul>
          </div><!-- .topsearch -->
        </div><!-- .site -->
      </div><!-- #header -->
    </div><!-- #header-wrapper -->
    <div id="wrapper">
      <div id="content" class="site">

        <h1>Cross datacenter UDP reliability</h1>

<em>Date: 04 May 2015</em><br>
<em>Author: Erik Dubbelboer</em>

<p>For an internal project I did some research into how reliable <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> really is. In our case each new packets would overwrite any old ones so missing a couple of packets would be no issue. With UDP it’s technically also possible for packets to arrive in a different order. This would easily be detected by having an incrementing version counter and only accepting the packet if it has a higher version than the last one we had seen.</p>

<p>As described missing a couple of packets wouldn’t be an issue as long as we don’t miss to many. To test how reliable UDP really is I setup a test between one of our servers in London and one in Salt Lake City.</p>

<p>The following <a href="https://golang.org/">Golang</a> code was run on the London side:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"encoding/binary"</span>
	<span class="s">"log"</span>
	<span class="s">"net"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">addr</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">ResolveUDPAddr</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="s">"0.0.0.0:9999"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">ListenUDP</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">current</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>

	<span class="n">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">1500</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>   
		<span class="k">if</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">conn</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="m">1400</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"only received %d bytes"</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="o">.</span><span class="n">Uint64</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
			<span class="n">missed</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">current</span>
			<span class="k">if</span> <span class="n">missed</span> <span class="o">!=</span> <span class="m">1</span> <span class="p">{</span>
				<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"missed %d packets"</span><span class="p">,</span> <span class="n">x</span><span class="o">-</span><span class="n">current</span><span class="o">-</span><span class="m">1</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="n">current</span> <span class="o">=</span> <span class="n">x</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This Golang code was run on the Salt Lake City side:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"encoding/binary"</span>
	<span class="s">"log"</span>
	<span class="s">"net"</span>
	<span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">raddr</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">ResolveUDPAddr</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="s">"london-1:9999"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">laddr</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">ResolveUDPAddr</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="s">"0.0.0.0:0"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">ListenUDP</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="n">laddr</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">current</span> <span class="o">:=</span> <span class="kt">int64</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="n">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">1400</span><span class="p">)</span>

	<span class="k">for</span> <span class="p">{</span>   
		<span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="o">.</span><span class="n">PutUint64</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="o">:</span><span class="m">8</span><span class="p">],</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">conn</span><span class="o">.</span><span class="n">WriteToUDP</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">raddr</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"only %d bytes written"</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="n">current</span><span class="o">++</span>

		<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span> <span class="o">*</span> <span class="m">500</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>I ran the two programs for multiple days. At the end of this post you can see the raw output. Below is a small table showing how many packets were missed per day:</p>

<pre>
day - misses
15  - 10
16  - 1
17  - 4
18  - 0
19  - 0
20  - 343
21  - 5
</pre>

<p>I did not expect the connection to be this stable. With 172.800 packets being send per day a loss of less than 10 packets (0,005%) is quite good and very usable. But what happened on the 20th shows where UDP is a problem. I did not notice on the day it self so I could not do any research, but my guess is that one or more of the networks between the servers had a higher usage than usual. This resulted in a lot of packets being dropped that day. Using TCP would probably have resulted in either the packets not being dropped or at least retried. My next test will be to run a TCP connection next to UDP to it to see if the TCP connection keeps being reliable while UDP fails.</p>

<p>My conclusion from this test was that UDP was almost reliable enough. We ended up using UDP for light frequent updates while using TCP for periodic slower updates.</p>

<p>Raw output:</p>

<pre>
2015/03/15 07:37:39 missed 1 packets
2015/03/15 07:43:42 missed 1 packets
2015/03/15 14:41:59 missed 1 packets
2015/03/15 14:42:32 missed 1 packets
2015/03/15 14:44:37 missed 1 packets
2015/03/15 14:49:15 missed 1 packets
2015/03/15 14:49:17 missed 1 packets
2015/03/15 14:49:19 missed 1 packets
2015/03/15 14:50:04 missed 1 packets
2015/03/15 15:40:02 missed 1 packets
2015/03/16 20:11:26 missed 1 packets
2015/03/17 10:58:57 missed 3 packets
2015/03/17 10:58:58 missed 1 packets
2015/03/20 06:46:25 missed 169 packets
2015/03/20 06:47:12 missed 8 packets
2015/03/20 06:47:32 missed 10 packets
2015/03/20 06:48:00 missed 33 packets
2015/03/20 06:48:27 missed 7 packets
2015/03/20 06:48:53 missed 14 packets
2015/03/20 06:49:14 missed 16 packets
2015/03/20 06:49:37 missed 15 packets
2015/03/20 06:50:11 missed 3 packets
2015/03/20 07:51:16 missed 10 packets
2015/03/20 14:43:35 missed 7 packets
2015/03/20 14:46:41 missed 4 packets
2015/03/20 15:14:05 missed 9 packets
2015/03/20 15:14:32 missed 11 packets
2015/03/20 15:14:50 missed 11 packets
2015/03/20 15:15:50 missed 3 packets
2015/03/20 15:16:37 missed 8 packets
2015/03/20 16:07:16 missed 1 packets
2015/03/20 16:07:18 missed 1 packets
2015/03/20 16:07:43 missed 1 packets
2015/03/20 16:07:45 missed 2 packets
2015/03/21 05:24:25 missed 3 packets
2015/03/21 07:37:53 missed 1 packets
2015/03/21 09:49:08 missed 2 packets
</pre>



<div id=disqus_thread></div>
<script>
  var disqus_shortname = 'erikscode';

  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>



      </div><!-- #content -->
    </div><!-- #wrapper -->
  </div><!-- #main -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-7915266-3', 'dubbelboer.com');
    ga('send', 'pageview');
  </script>
</body>
</html>
